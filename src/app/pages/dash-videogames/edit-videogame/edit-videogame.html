<h1 style="text-align:center;font-family: 'Press Start 2P'">Editar Videojuego</h1>
<div style="display:flex; justify-content:center; width:100%;">
<div class="grid" style="display:grid; gap:1rem; grid-template-columns: 1fr; max-width: 780px; width:100%;">
  <p-floatlabel variant="on">
    <input pInputText id="title" class="w-full" [(ngModel)]="model.title" required />
    <label for="title">Titulo</label>
  </p-floatlabel>

  <p-floatlabel variant="on">
    <textarea inputId="description" class="w-full" pInputTextarea [autoResize]="true" rows="4" cols="30" [(ngModel)]="model.description"></textarea>
    <label for="description">Descripcion</label>
  </p-floatlabel>

  <div class="row" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
    <p-floatlabel variant="on">   
      <p-inputNumber inputId="integeronly" [(ngModel)]="model.stock" mode="decimal" class="w-full" [min]="0"></p-inputNumber>
      <label for="integeronly">Cantidad</label>
    </p-floatlabel>
    <p-floatlabel variant="on">
      <p-inputNumber inputId="price" [(ngModel)]="model.price" mode="currency" class="w-full" currency="PEN" locale="es-PE"></p-inputNumber>
      <label for="price">Precio Unitario</label>
    </p-floatlabel>
  </div>

  <p-multiselect [options]="states" [(ngModel)]="model.state" placeholder="Seleccione estado" [selectionLimit]="1" display="chip" class="w-full"></p-multiselect>
  <p-multiselect [options]="consoles" [(ngModel)]="model.console" placeholder="Seleccione Consola" [filter]="true" [selectionLimit]="1" display="chip" class="w-full"></p-multiselect>

  <div style="display:flex; align-items:center; gap:.5rem;">
    <p-checkbox inputId="hasDiscount" [(ngModel)]="model.hasDiscount" binary="true"></p-checkbox>
    <label for="hasDiscount">¿Tiene descuento?</label>
  </div>
  <p-multiselect [options]="promos" optionLabel="description" [(ngModel)]="selectedPromos" placeholder="Seleccione Promociones" [disabled]="!model.hasDiscount" display="chip" class="w-full"></p-multiselect>

  <p-multiselect [options]="categories" optionLabel="description" [(ngModel)]="selectedCategories" placeholder="Seleccione Categorías" display="chip" class="w-full"></p-multiselect>

  <p-toast></p-toast>

  <ng-container *ngFor="let field of imageInputs">
    <div class="card" style="border: 1px dashed #ccc; padding: 1rem; border-radius: .5rem;">
      <h4 style="margin-top: 0;">{{ field.label }}</h4>
      <div style="display:flex; gap:.5rem; flex-wrap: wrap; align-items:center;">
        <p-fileupload
          #uploader
          mode="basic"
          chooseLabel="Elegir"
          chooseIcon="pi pi-upload"
          name="image-{{ field.key }}"
          url="https://www.primefaces.org/cdn/api/upload.php"
          accept="image/*"
          [maxFileSize]="maxFileSize"
          [customUpload]="true"
          (uploadHandler)="onSingleImageUpload($event, field.key)"
        ></p-fileupload>
        <p-button label="Upload" (onClick)="uploader.upload()" severity="secondary"></p-button>
      </div>
      <p-image *ngIf="getPreview(field.key)" [src]="getPreview(field.key)" [alt]="field.label" width="250"></p-image>
    </div>
  </ng-container>

  <p-fileupload
    #archiveUpload
    name="archives[]"
    url="https://www.primefaces.org/cdn/api/upload.php"
    [multiple]="true"
    accept=".zip,.rar,application/zip,application/x-rar-compressed"
    [maxFileSize]="maxFileSize"
    [customUpload]="true"
    (uploadHandler)="onTemplatedUpload($event)"
    (onSelect)="onSelectedFiles($event)"
  >
    <ng-template
      #header
      let-files
      let-chooseCallback="chooseCallback"
      let-clearCallback="clearCallback"
      let-uploadCallback="uploadCallback"
    >
      <div class="flex flex-wrap justify-between items-center flex-1 gap-4" style="display:flex; flex-wrap:wrap; gap:1rem;">
        <div class="flex gap-2" style="display:flex; gap:.5rem;">
          <p-button
            (onClick)="choose($event, chooseCallback)"
            icon="pi pi-folder-open"
            [rounded]="true"
            [outlined]="true"
          ></p-button>
          <p-button
            (onClick)="uploadEvent(uploadCallback)"
            icon="pi pi-cloud-upload"
            [rounded]="true"
            [outlined]="true"
            severity="success"
            [disabled]="!files || files.length === 0"
          ></p-button>
          <p-button
            (onClick)="handleTemplateClear(clearCallback)"
            icon="pi pi-times"
            [rounded]="true"
            [outlined]="true"
            severity="danger"
            [disabled]="!files || files.length === 0"
          ></p-button>
        </div>
        <p-progressbar
          [value]="totalSizePercent"
          [showValue]="false"
          style="width:100%; max-width:20rem; height:4px;"
        >
          <span class="whitespace-nowrap">{{ formatSize(totalSize) }} / 20 MB</span>
        </p-progressbar>
      </div>
    </ng-template>
    <ng-template
      #content
      let-files
      let-uploadedFiles="uploadedFiles"
      let-removeFileCallback="removeFileCallback"
      let-removeUploadedFileCallback="removeUploadedFileCallback"
    >
      <div class="flex flex-col gap-8 pt-4" style="display:flex; flex-direction:column; gap:1rem; padding-top:1rem;">
        <div *ngIf="files?.length > 0">
          <h5>Pending</h5>
          <div class="flex flex-wrap gap-4" style="display:flex; flex-wrap:wrap; gap:1rem;">
            <div
              *ngFor="let file of files; let i = index"
              class="p-8 rounded-border flex flex-col border border-surface items-center gap-4"
              style="padding:1rem; border:1px solid #e2e2e2; border-radius:.5rem; display:flex; flex-direction:column; align-items:center; gap:.5rem;"
            >
              <div>
                  @if (file.type?.startsWith('image/')) {
                    <img [src]="file.objectURL" [alt]="file.name" width="100" height="70" style="object-fit:cover; border-radius:.25rem;" />
                  } @else if (file.name.endsWith('.zip') || file.name.endsWith('.rar') || file.name.endsWith('.7z') || file.name.endsWith('.tar')) {
                    <i class="pi pi-discord" style="font-size:3rem; color:#7289da;"></i>
                  } @else {
                    <i class="pi pi-file" style="font-size:3rem; color:#90caf9;"></i>
                  }
              </div>
              <span class="font-semibold text-ellipsis max-w-60 whitespace-nowrap overflow-hidden">{{ file.name }}</span>
              <div>{{ formatSize(file.size) }}</div>
              <p-badge
                [value]="file.uploaded ? 'Completed' : 'Pending'"
                [severity]="file.uploaded ? 'success' : 'warn'">
              </p-badge>

              <p-button
                icon="pi pi-times"
                (onClick)="onRemoveTemplatingFile($event, file, removeFileCallback, i)"
                [outlined]="true"
                [rounded]="true"
                severity="danger"
              ></p-button>
            </div>
          </div>
        </div>
        <div *ngIf="uploadedFiles?.length > 0">
          <h5>Completed</h5>
          <div class="flex flex-wrap gap-4" style="display:flex; flex-wrap:wrap; gap:1rem;">
            <div
              *ngFor="let file of uploadedFiles; let i = index"
              class="card m-0 px-12 flex flex-col border border-surface items-center gap-4"
              style="padding:1rem; border:1px solid #e2e2e2; border-radius:.5rem; display:flex; flex-direction:column; align-items:center; gap:.5rem;"
            >
              <div>
                <img role="presentation" [alt]="file.name" [src]="file.objectURL" width="100" height="50" />
              </div>
              <span class="font-semibold text-ellipsis max-w-60 whitespace-nowrap overflow-hidden">{{ file.name }}</span>
              <div>{{ formatSize(file.size) }}</div>
              <p-badge value="Completed" class="mt-4" severity="success"></p-badge>
              <p-button
                icon="pi pi-times"
                (onClick)="removeUploadedFileCallback(i)"
                [outlined]="true"
                [rounded]="true"
                severity="danger"
              ></p-button>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template #file></ng-template>
    <ng-template #empty>
      <div class="flex items-center justify-center flex-col" style="text-align:center; padding:2rem;">
        <i class="pi pi-cloud-upload" style="border:2px dashed; border-radius:999px; padding:1rem; font-size:2rem;"></i>
        <p class="mt-6 mb-0">Arrastra y suelta archivos aquí para subirlos.</p>
      </div>
    </ng-template>
  </p-fileupload>

  <button pButton type="button" label="Volver" icon="pi pi-arrow-left" routerLink="/list-videogames"></button>
  <span style="flex:1 1 auto"></span>
  <button pButton type="button" severity="success" label="Actualizar" icon="pi pi-save" (click)="update()"></button>
</div>
</div>